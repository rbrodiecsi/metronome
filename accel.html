<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Accel POC</title>
  <style>
    body { font-family: sans-serif; padding: 1rem; }
    #output { font-size: 1.25rem; margin-top: 1rem; }
    button { padding: .5rem 1rem; font-size: 1rem; }
  </style>
</head>
<body>
  <h1>Accelerometer Summary (last 1 sec)</h1>
  <button id="startBtn">Start Sensors</button>
  <div id="output">Waiting to start…</div>

  <script>
    const output = document.getElementById('output');
    const startBtn = document.getElementById('startBtn');

    // buffer: array of { t: timestamp, x,y,z }
    let buffer = [];

    function summarizeAndDisplay() {
      const now = performance.now();
      // keep only last 1000ms
      buffer = buffer.filter(d => now - d.t <= 1000);
      const N = buffer.length;
      if (N === 0) {
        output.textContent = 'No samples in the last second.';
        return;
      }
      const sums = buffer.reduce((s, d) => {
        s.x += d.x; s.y += d.y; s.z += d.z;
        return s;
      }, { x: 0, y: 0, z: 0 });

      const avg = {
        x: sums.x / N,
        y: sums.y / N,
        z: sums.z / N
      };

      output.textContent = 
        `Samples: ${N} · ` +
        `Avg X:${avg.x.toFixed(2)} ` +
        `Y:${avg.y.toFixed(2)} ` +
        `Z:${avg.z.toFixed(2)}`;
    }

    function startGenericSensor() {
      try {
        const sensor = new Accelerometer({ frequency: 60 });
        sensor.addEventListener('reading', () => {
          buffer.push({ 
            t: performance.now(), 
            x: sensor.x, 
            y: sensor.y, 
            z: sensor.z 
          });
        });
        sensor.addEventListener('error', e => {
          console.error('Generic Sensor error', e.error);
          fallbackToDeviceMotion();
        });
        sensor.start();
      } catch (e) {
        console.warn('Accelerometer ctor failed:', e);
        fallbackToDeviceMotion();
      }
    }

    function fallbackToDeviceMotion() {
      if (!('DeviceMotionEvent' in window)) {
        output.textContent = 'No accelerometer support.';
        return;
      }
      // iOS 13+ permission
      function listen() {
        window.addEventListener('devicemotion', ev => {
          const a = ev.acceleration || ev.accelerationIncludingGravity;
          if (a) {
            buffer.push({ t: performance.now(), x: a.x, y: a.y, z: a.z });
          }
        });
      }
      if (typeof DeviceMotionEvent.requestPermission === 'function') {
        DeviceMotionEvent.requestPermission()
          .then(p => {
            if (p === 'granted') listen();
            else output.textContent = 'Permission denied.';
          })
          .catch(err => {
            console.error(err);
            output.textContent = 'Permission error.';
          });
      } else {
        listen();
      }
    }

    startBtn.addEventListener('click', () => {
      startBtn.disabled = true;
      output.textContent = 'Starting…';
      startGenericSensor();
      // every 1s, update summary
      setInterval(summarizeAndDisplay, 1000);
    });
  </script>
</body>
</html>
