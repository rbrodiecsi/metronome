<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Live Accelerometer Chart</title>
  <style>
    body { font-family: sans-serif; padding: 1rem; background: #f5f5f5; }
    #controls { margin-bottom: 1rem; }
    canvas { background: #fff; border: 1px solid #ccc; }
    button { padding: .5rem 1rem; font-size: 1rem; }
  </style>
</head>
<body>
  <div id="controls">
    <button id="startBtn">Start Sensors & Chart</button>
  </div>
  <canvas id="accelChart" width="600" height="300"></canvas>

  <!-- Chart.js from CDN -->
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <script>
    const buf = []; // holds {t: ms, x,y,z}
    const DURATION = 5000; // ms to show
    let chart, sensor;

    // 1) Set up Chart.js with empty data
    function createChart() {
      const ctx = document.getElementById('accelChart').getContext('2d');
      chart = new Chart(ctx, {
        type: 'line',
        data: {
          labels: [], // timestamps
          datasets: [
            { label: 'X', data: [], borderColor: 'red',    fill: false },
            { label: 'Y', data: [], borderColor: 'green',  fill: false },
            { label: 'Z', data: [], borderColor: 'blue',   fill: false },
          ]
        },
        options: {
          animation: false,
          scales: {
            x: {
              type: 'realtime',   // requires chartjs-plugin-streaming
              realtime: {
                duration: DURATION,
                refresh: 100,
                delay: 0,
                onRefresh: updateChart
              }
            },
            y: { suggestedMin: -20, suggestedMax: 20 }
          },
          plugins: {
            streaming: {           // chartjs-plugin-streaming options
              frameRate: 30       // limits chart redraws/sec
            }
          }
        }
      });
    }

    // 2) Pull last 5s from buf and push into chart
    function updateChart(chart) {
      const now = performance.now();
      // prune old
      while (buf.length && now - buf[0].t > DURATION) buf.shift();

      chart.data.datasets[0].data.push({
        x: now,
        y: buf.length ? buf[buf.length-1].x : null
      });
      chart.data.datasets[1].data.push({
        x: now,
        y: buf.length ? buf[buf.length-1].y : null
      });
      chart.data.datasets[2].data.push({
        x: now,
        y: buf.length ? buf[buf.length-1].z : null
      });
    }

    // 3) Sensor setup (Generic â†’ fallback)
    function startSensor() {
      if ('Accelerometer' in window) {
        try {
          sensor = new Accelerometer({ frequency: 60 });
          sensor.addEventListener('reading', () => {
            buf.push({ t: performance.now(), x: sensor.x, y: sensor.y, z: sensor.z });
          });
          sensor.addEventListener('error', e => {
            console.warn('Accel error', e.error);
            fallback();
          });
          sensor.start();
          return;
        } catch (e) {
          console.warn('Accelerometer ctor failed', e);
        }
      }
      fallback();
    }

    function fallback() {
      if (!('DeviceMotionEvent' in window)) {
        alert('No accelerometer support!');
        return;
      }
      function listen() {
        window.addEventListener('devicemotion', ev => {
          const a = ev.accelerationIncludingGravity || ev.acceleration;
          if (!a) return;
          buf.push({ t: performance.now(), x: a.x, y: a.y, z: a.z });
        });
      }
      if (typeof DeviceMotionEvent.requestPermission === 'function') {
        DeviceMotionEvent.requestPermission()
          .then(p => p === 'granted' ? listen() : alert('Permission denied'))
          .catch(console.error);
      } else {
        listen();
      }
    }

    // 4) Wire up start button
    document.getElementById('startBtn').addEventListener('click', () => {
      document.getElementById('startBtn').disabled = true;
      createChart();
      startSensor();
    });
  </script>

  <!-- NOTE: chartjs-plugin-streaming is required for real-time chart support -->
  <script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-streaming@2.0.0"></script>
</body>
</html>
